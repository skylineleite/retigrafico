<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Retigráfico - Coleta</title>

  <link rel="manifest" href="manifest.webmanifest?v=3">
  <meta name="theme-color" content="#f8fafc">

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --ok:#8BC34A; --mid:#FFEB3B; --bad:#F44336;
      --worse:#9C27B0; --dead:#212121; /* Novas Cores */
      --ink:#020617; --muted:#64748b; --brand:#0ea5e9;
      --bg:#f8fafc; --card:#ffffff;
      --radius:16px; --kmA:#f5fbff; --kmB:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,sans-serif;
      margin:0; background:var(--bg); color:var(--ink);
      padding-bottom: 40px;
    }
    .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
    
    header{
      display:flex; align-items:center; gap:12px;
      margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid #e2e8f0;
    }
    .btn-back {
      background:transparent; border:1px solid #cbd5e1; color:var(--muted);
      padding:8px 12px; border-radius:10px; font-weight:600; font-size:14px;
      cursor:pointer; display:flex; align-items:center; gap:4px;
    }

    .card{
      background:var(--card); border-radius:var(--radius);
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); padding:16px;
      border:1px solid #e2e8f0; margin-bottom:12px;
    }
    .grid{display:grid;gap:10px}
    .g-3{grid-template-columns:repeat(3,1fr)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    
    input,button,select{ padding:12px; border-radius:12px; border:1px solid #cbd5e1; font-size:16px; outline:none; }
    input:focus, select:focus{ border-color:var(--brand); }
    input[type=number],input[type=text],select{ background:#fff; width:100%; }
    
    button{ background:var(--brand); color:#fff; border:none; cursor:pointer; font-weight:600; }
    button.ghost{ background:#fff; color:var(--brand); border:1px solid var(--brand); }
    button.warn{ background:#fff; color:#d97706; border:1px solid #d97706; }
    button.danger{ background:#fee2e2; color:#ef4444; border:1px solid #ef4444; }
    
    .modal-back{
      position:fixed; inset:0; background:rgba(0,0,0,0.85);
      display:flex; align-items:center; justify-content:center; z-index:100;
      backdrop-filter:blur(4px);
    }
    .modal-card {
      background:#fff; padding:24px; border-radius:16px; width:340px; max-width:90%;
      text-align:center; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);
    }
    .hidden{display:none;}

    .table-wrap{ max-height:500px; overflow:auto; border-radius:12px; border:1px solid #e2e8f0; margin-top:12px; }
    table{ border-collapse:separate; border-spacing:0; width:100%; font-size:14px; min-width:650px; }
    th,td{ border-bottom:1px solid #e2e8f0; padding:10px; text-align:left; vertical-align:middle; }
    th{ background:#f1f5f9; font-size:12px; text-transform:uppercase; color:#475569; position:sticky; top:0; z-index:2; }
    
    .chip{
      padding:8px 8px; border-radius:99px; border:1px solid #cbd5e1; background:#f1f5f9;
      color:#334155; font-size:12px; font-weight:700; cursor:pointer; display:inline-flex;
      align-items:center; justify-content:center; min-width:32px; transition:all 0.1s;
    }
    .chip.active { transform:scale(1.1); border-width:2px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    
    /* CORES DOS CHIPS */
    .chip.ok.active { background:var(--ok); border-color:#558b2f; color:#fff; }
    .chip.mid.active { background:var(--mid); border-color:#fbc02d; color:#000; }
    .chip.bad.active { background:var(--bad); border-color:#c62828; color:#fff; }
    .chip.worse.active { background:var(--worse); border-color:#7B1FA2; color:#fff; }
    .chip.dead.active { background:var(--dead); border-color:#000; color:#fff; }

    .photo-thumb{ width:60px; height:60px; object-fit:cover; border-radius:8px; border:1px solid #e2e8f0; cursor:pointer; }
    .photo-grid{ display:flex; gap:8px; flex-wrap:wrap; margin-top:4px; }
    .photo-empty{ width:60px; height:60px; border-radius:8px; border:2px dashed #cbd5e1; display:flex; align-items:center; justify-content:center; color:#64748b; cursor:pointer; background:#f8fafc; }

    .heat-grid{ display:grid; gap:1px; margin-top:10px; overflow-x:auto; border-radius:8px; border:1px solid #e2e8f0; background:#e2e8f0; }
    .heat-row{ display:grid; grid-auto-flow:column; }
    .heat-cell{ width:24px; height:24px; font-size:10px; display:flex; align-items:center; justify-content:center; }
    
    .stat-card{ flex:1 1 140px; background:#f8fafc; border-radius:12px; padding:12px; border:1px solid #e2e8f0; }
    .bar-wrap{ height:8px; background:#e2e8f0; border-radius:99px; overflow:hidden; margin-top:6px; }
    .bar-inner{ height:100%; }

    .icon-btn { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .icon-wa { width: 18px; height: 18px; fill: currentColor; }

    @media (max-width:768px){ .g-3{grid-template-columns:1fr} .btn-row{flex-direction:column;align-items:stretch} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <button class="btn-back" onclick="goBack()"><span>&#8592;</span> Voltar</button>
      <img src="app-logo.png" alt="R" style="width:36px;height:36px;border-radius:8px">
      <div style="flex:1">
        <h1 style="font-size:18px;margin:0;line-height:1.2">Retigráfico</h1>
        <div id="fileLabel" class="small" style="color:var(--muted);font-size:12px">Novo Arquivo</div>
      </div>
    </header>

    <div class="card">
      <div class="card-title" style="font-weight:700;margin-bottom:12px;display:flex;justify-content:space-between">
        <span>1. Parâmetros</span>
      </div>
      <div class="grid g-3">
        <div><label>Rodovia / UF</label><input id="rodoviaUF" type="text" placeholder="Ex.: BR-040 / MG"></div>
        <div><label>KM Inicial</label><input id="kmStart" type="number" placeholder="Ex.: 256"></div>
        <div><label>KM Final</label><input id="kmEnd" type="number" placeholder="Ex.: 260"></div>
      </div>
      
      <div style="margin-top:16px">
        <label>Modelo de Avaliação</label>
        <select id="modelSelect">
          <option value="padrao">Roçada Padrão (1 a 3)</option>
          <option value="detalhado">Roçada Detalhada (1 a 5)</option>
          <option value="drenagem">Drenagem (Limpa/Suja/Obstruída)</option>
        </select>
      </div>

      <div style="margin-top:16px">
        <label>Sentido / Pista</label>
        <div id="sentidosBox" class="row" style="margin-top:8px; gap:12px"></div>
      </div>
      <div class="row btn-row" style="margin-top:16px">
        <button id="btnGerar">Gerar / Atualizar Tabela</button>
        <button id="btnReset" class="ghost warn">Limpar Tudo</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="font-weight:700;margin-bottom:12px;display:flex;justify-content:space-between">
        <span>2. Coleta de Campo</span>
        <button id="btnTudoBom" class="ghost" style="font-size:12px;padding:6px 10px">Tudo 1 (Bom/Limpa)</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>KM</th><th>Seção</th><th style="min-width:180px">Condição</th><th>Fotos</th><th>Obs</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="font-weight:700;margin-bottom:12px">
        <span>3. Retigráfico Visual e Status</span>
      </div>
      <div id="heatWrap"></div>
      <div id="statsWrap"></div>

      <div class="row btn-row" style="margin-top:20px; justify-content:flex-end; border-top:1px solid #e2e8f0; padding-top:16px">
        <button id="btnSave" style="background:#64748b">Salvar Arquivo</button>
        <button id="btnExportCSV" class="ghost">CSV</button>
        <button id="btnExportXLSX" class="ghost">XLSX (Relatório)</button>
        <button id="btnShare" style="background:#25D366; color:#fff" class="icon-btn">
          <svg class="icon-wa" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
          Encaminhar
        </button>
      </div>
    </div>
  </div>

  <div id="photoModal" class="modal-back hidden">
    <div style="text-align:center">
      <img id="photoModalImg" src="" style="max-width:95vw;max-height:80vh;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.5)">
      <div style="margin-top:10px"><button onclick="document.getElementById('photoModal').classList.add('hidden')" style="background:#fff;color:#000;border-radius:20px">Fechar</button></div>
    </div>
  </div>
  <div id="saveModal" class="modal-back hidden">
    <div class="modal-card">
      <h3>Salvar</h3>
      <input id="saveFileName" type="text" style="width:100%;margin-bottom:16px">
      <div class="icon-btn"><button id="btnConfirmSave" style="flex:1">Salvar</button><button onclick="document.getElementById('saveModal').classList.add('hidden')" class="ghost">Cancelar</button></div>
    </div>
  </div>
  <div id="changeModal" class="modal-back hidden">
    <div class="modal-card">
      <h3>Alterar?</h3>
      <p style="color:var(--muted)">Arquivo protegido.</p>
      <div class="icon-btn"><button id="btnAllowEdit" style="flex:1">Alterar</button><button onclick="document.getElementById('changeModal').classList.add('hidden')" class="ghost">Não</button></div>
    </div>
  </div>
  <div id="resetModal" class="modal-back hidden">
    <div class="modal-card">
      <h3>⚠️ Limpar</h3>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button id="btnSafetyExport">Baixar XLSX</button>
        <button id="btnConfirmReset" class="danger">Apagar Tudo</button>
        <button onclick="document.getElementById('resetModal').classList.add('hidden')" class="ghost">Cancelar</button>
      </div>
    </div>
  </div>
  <div id="exitModal" class="modal-back hidden">
    <div class="modal-card">
      <h3>Sair?</h3>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button id="btnExitSave">Salvar</button>
        <button id="btnExitNoSave" class="danger">Não Salvar</button>
        <button onclick="document.getElementById('exitModal').classList.add('hidden')" class="ghost">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    // --- DEFINIÇÃO DOS MODELOS ---
    const MODELS = {
      'padrao': {
        name: 'Roçada Padrão (1-3)',
        opts: [
          {v:1, l:'Bom', c:'ok', color:'#8BC34A'},
          {v:2, l:'Reg', c:'mid', color:'#FFEB3B'},
          {v:3, l:'Cri', c:'bad', color:'#F44336'}
        ]
      },
      'detalhado': {
        name: 'Roçada Detalhada (1-5)',
        opts: [
          {v:1, l:'Bom', c:'ok', color:'#8BC34A'},
          {v:2, l:'Reg', c:'mid', color:'#FFEB3B'},
          {v:3, l:'Cri', c:'bad', color:'#F44336'},
          {v:4, l:'Pés', c:'worse', color:'#9C27B0'},
          {v:5, l:'Int', c:'dead', color:'#212121'}
        ]
      },
      'drenagem': {
        name: 'Drenagem (1-3)',
        opts: [
          {v:1, l:'Limp', c:'ok', color:'#8BC34A'},
          {v:2, l:'Suja', c:'mid', color:'#FFEB3B'},
          {v:3, l:'Obs', c:'bad', color:'#F44336'}
        ]
      }
    };

    const INDEX_KEY = 'retigrafico_index_v1';
    let currentId = null; 
    let isFileProtected = false;
    let hasUnsavedChanges = false;
    
    // State agora inclui o 'model'
    let state = {
      kmStart:0, kmEnd:0, rodoviaUF:'', selectedSecoes:[], data:{},
      model: 'padrao', // Default
      metadata: { created: new Date().toISOString() }
    };

    function init() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      const isNew = params.get('new');
      const action = params.get('action');

      if (id) {
        const raw = localStorage.getItem(id);
        if (raw) {
          state = JSON.parse(raw);
          // Fallback para arquivos antigos sem model definido
          if(!state.model) state.model = 'padrao';
          
          currentId = id;
          isFileProtected = true;
          document.getElementById('fileLabel').innerText = state.metadata.name || 'Arquivo Salvo';
          
          // Travar o seletor de modelo se já tiver dados
          document.getElementById('modelSelect').disabled = true;
        }
      } else if (isNew) {
        currentId = null;
        isFileProtected = false;
        state.model = 'padrao';
      }
      
      if (action === 'share' && currentId) setTimeout(shareFile, 1000);

      renderAll();
    }

    function requestEditAccess(callback) {
      if (isFileProtected) {
        document.getElementById('changeModal').classList.remove('hidden');
        document.getElementById('btnAllowEdit').onclick = () => {
          isFileProtected = false;
          document.getElementById('modelSelect').disabled = false;
          document.getElementById('changeModal').classList.add('hidden');
          hasUnsavedChanges = true;
          callback();
        };
      } else {
        hasUnsavedChanges = true;
        callback();
      }
    }

    function ensure(secao,km){
      state.data[secao]??={};
      state.data[secao][km]??={status:null,obs:'',photos:[]};
    }
    
    function range(a,b){
      const r=[]; const step=a<=b?1:-1;
      for(let i=a;i!==b+step;i+=step) r.push(i);
      return r;
    }
    
    function getSecoes(){
      return state.selectedSecoes && state.selectedSecoes.length ? state.selectedSecoes : ["Sul","CC","Norte"];
    }
    
    function getModelOpts(){
      return MODELS[state.model || 'padrao'].opts;
    }

    // --- RENDERIZADORES ---
    function renderAll() {
      document.getElementById('rodoviaUF').value = state.rodoviaUF || '';
      document.getElementById('kmStart').value = state.kmStart || '';
      document.getElementById('kmEnd').value = state.kmEnd || '';
      document.getElementById('modelSelect').value = state.model || 'padrao';
      
      renderSentidosBox();
      renderTable();
      renderHeat();
      renderStats();
    }

    function renderSentidosBox() {
      const box = document.getElementById('sentidosBox');
      box.innerHTML = '';
      ["Sul","CC","Norte","Leste","Oeste"].forEach(s => {
        const wrap = document.createElement('label');
        wrap.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px;background:#fff;border-radius:8px;border:1px solid #e2e8f0';
        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.value = s;
        if (getSecoes().includes(s)) cb.checked = true;
        cb.onclick = (e) => {
          if (isFileProtected) { e.preventDefault(); requestEditAccess(() => { cb.checked = !cb.checked; updateSentidos(); }); } 
          else { setTimeout(updateSentidos, 0); }
        };
        wrap.append(cb, s);
        box.appendChild(wrap);
      });
    }

    function updateSentidos() {
      state.selectedSecoes = Array.from(document.querySelectorAll('#sentidosBox input:checked')).map(i=>i.value);
      renderAll();
    }

    function renderTable() {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      if(!state.kmStart && !state.kmEnd) return;
      
      const kms = range(state.kmStart, state.kmEnd);
      const sentidos = getSecoes();
      const opts = getModelOpts();

      kms.forEach((km, idx) => {
        const bg = idx%2===0 ? 'var(--kmA)' : 'var(--kmB)';
        sentidos.forEach((secao, sIdx) => {
          ensure(secao, km);
          const ponto = state.data[secao][km];
          const tr = document.createElement('tr');
          tr.style.background = bg;

          if(sIdx===0) {
            const tdKm = document.createElement('td');
            tdKm.rowSpan = sentidos.length;
            tdKm.textContent = km;
            tdKm.style.cssText = 'font-weight:800;text-align:center;vertical-align:middle;border-right:1px solid #e2e8f0;font-size:16px';
            tr.appendChild(tdKm);
          }

          const tdSec = document.createElement('td');
          tdSec.textContent = secao;
          tdSec.style.fontSize = '12px';
          tr.appendChild(tdSec);

          // Renderização Dinâmica dos Chips
          const tdSt = document.createElement('td');
          const rowSt = document.createElement('div');
          rowSt.className='row';
          opts.forEach(opt => {
             const chip = document.createElement('div');
             chip.className = `chip ${opt.c}`;
             if(ponto.status === opt.v) chip.classList.add('active');
             chip.textContent = opt.v; // Mostra número
             chip.title = opt.l;       // Mostra label ao passar mouse
             chip.onclick = () => requestEditAccess(() => {
                ponto.status = (ponto.status === opt.v ? null : opt.v);
                renderAll();
             });
             rowSt.appendChild(chip);
          });
          tdSt.appendChild(rowSt);
          tr.appendChild(tdSt);

          // Fotos
          const tdF = document.createElement('td');
          const grid = document.createElement('div'); grid.className='photo-grid';
          (ponto.photos||[]).forEach((ph, i) => {
             const img = document.createElement('img');
             img.src = ph.data; img.className = 'photo-thumb';
             img.onclick = () => { document.getElementById('photoModalImg').src = ph.data; document.getElementById('photoModal').classList.remove('hidden'); }
             img.oncontextmenu = (e) => { e.preventDefault(); requestEditAccess(() => { if(confirm('Apagar?')) { ponto.photos.splice(i,1); renderAll(); } }); };
             grid.appendChild(img);
          });
          if((ponto.photos||[]).length < 3) {
             const add = document.createElement('label'); add.className='photo-empty'; add.innerHTML='+';
             const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.style.display='none';
             inp.onchange = (e) => requestEditAccess(() => handlePhoto(e, ponto, secao, km));
             add.onclick = () => inp.click(); add.appendChild(inp); grid.appendChild(add);
          }
          tdF.appendChild(grid); tr.appendChild(tdF);

          const tdObs = document.createElement('td');
          const ipt = document.createElement('input'); ipt.value = ponto.obs||''; ipt.placeholder = '...';
          ipt.onchange = () => requestEditAccess(() => { ponto.obs = ipt.value; });
          tdObs.appendChild(ipt); tr.appendChild(tdObs);

          tbody.appendChild(tr);
        });
      });
    }

    function renderHeat(){
      const wrap=document.getElementById('heatWrap'); wrap.innerHTML='';
      if(!state.kmStart && !state.kmEnd) return;
      const kms=range(state.kmStart,state.kmEnd); const sentidos=getSecoes();
      const opts = getModelOpts();
      
      const frame=document.createElement('div'); frame.className='heat-grid';
      const hRow=document.createElement('div'); hRow.className='heat-row';
      hRow.appendChild(Object.assign(document.createElement('div'),{className:'heat-cell',textContent:''}));
      kms.forEach(k=>hRow.appendChild(Object.assign(document.createElement('div'),{className:'heat-cell',textContent:k,style:'font-weight:bold'})));
      frame.appendChild(hRow);
      
      sentidos.forEach(s=>{
        const row=document.createElement('div'); row.className='heat-row';
        row.appendChild(Object.assign(document.createElement('div'),{className:'heat-cell',textContent:s,style:'width:50px;justify-content:flex-start;padding-left:4px'}));
        kms.forEach(k=>{
           ensure(s,k); const v=state.data[s][k].status;
           const c=document.createElement('div'); c.className='heat-cell';
           // Acha a cor no modelo
           const opt = opts.find(o => o.v === v);
           c.style.background = opt ? opt.color : 'transparent';
           if(opt && (opt.c === 'worse' || opt.c === 'dead')) c.style.color = '#fff'; // Texto branco para fundo escuro
           if(v) c.textContent=v;
           row.appendChild(c);
        });
        frame.appendChild(row);
      });
      wrap.appendChild(frame);
    }

    function renderStats() {
      const wrap = document.getElementById('statsWrap'); wrap.innerHTML='';
      const kms = range(state.kmStart, state.kmEnd);
      const sentidos = getSecoes();
      const opts = getModelOpts();
      
      let filled = 0;
      let counts = {}; 
      opts.forEach(o => counts[o.v] = 0);

      const totalPossible = kms.length * sentidos.length;
      sentidos.forEach(s => kms.forEach(k => {
         const p = state.data[s] && state.data[s][k];
         if(p && p.status) { 
           filled++; 
           if(counts[p.status] !== undefined) counts[p.status]++;
         }
      }));
      
      const pct = totalPossible ? Math.round((filled/totalPossible)*100) : 0;
      const div = document.createElement('div');
      div.className = 'row'; div.style.marginTop='16px';
      
      let html = `
        <div class="stat-card" style="border-color:var(--brand)">
           <div style="font-size:20px;font-weight:800;color:var(--brand)">${filled} / ${totalPossible}</div>
           <div class="small">Avaliados</div>
           <div class="bar-wrap"><div class="bar-inner" style="width:${pct}%;background:var(--brand)"></div></div>
        </div>`;
      
      opts.forEach(o => {
        const cVal = counts[o.v] || 0;
        const cPct = filled ? (cVal/filled)*100 : 0;
        html += `
        <div class="stat-card">
           <div style="font-size:20px;font-weight:800">${cVal}</div>
           <div class="small">${o.l}</div>
           <div class="bar-wrap"><div class="bar-inner" style="width:${cPct}%; background:${o.color}"></div></div>
        </div>`;
      });
      
      div.innerHTML = html;
      wrap.appendChild(div);
    }

    // --- GRÁFICO DINÂMICO PARA EXPORTAÇÃO ---
    function generatePieChartImage(countsData, opts) {
        const canvas = document.createElement('canvas');
        canvas.width = 400; canvas.height = 300;
        const ctx = canvas.getContext('2d');
        
        const total = countsData.reduce((acc, val) => acc + val, 0) || 1;
        let startAngle = -Math.PI / 2;

        ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,400,300);
        const centerX = 150; const centerY = 150; const radius = 100;

        // Desenha fatias
        countsData.forEach((val, i) => {
            const sliceAngle = (val / total) * 2 * Math.PI;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
            ctx.closePath();
            ctx.fillStyle = opts[i].color;
            ctx.fill();
            startAngle += sliceAngle;
        });

        // Legenda Dinâmica
        ctx.font = "14px Arial";
        opts.forEach((o, i) => {
            ctx.fillStyle = o.color;
            ctx.fillRect(270, 80 + (i*30), 15, 15);
            ctx.fillStyle = "#000";
            const val = countsData[i];
            const p = Math.round((val/total)*100);
            ctx.fillText(`${o.l}: ${p}%`, 295, 92 + (i*30));
        });

        return canvas.toDataURL('image/png');
    }

    async function exportXLSX(){
      if(!state.kmStart || !state.kmEnd){ alert('Intervalo indefinido.'); return; }
      const wb = new ExcelJS.Workbook();
      const kms = range(state.kmStart, state.kmEnd);
      const sentidos = getSecoes();
      const opts = getModelOpts();

      // Contagem para estatísticas
      let counts = new Array(opts.length).fill(0);
      let total = 0;
      
      sentidos.forEach(s => kms.forEach(k => {
         const p = state.data[s]?.[k];
         if(p && p.status){
             total++;
             // Achar indice no opts
             const idx = opts.findIndex(o => o.v === p.status);
             if(idx >= 0) counts[idx]++;
         }
      }));

      // ABA 1: VISUAL
      const wsRet = wb.addWorksheet('Retigrafico');
      wsRet.mergeCells('A1:B1'); wsRet.getCell('A1').value = 'Rodovia/UF'; wsRet.getCell('A1').font={bold:true};
      wsRet.getCell('C1').value = state.rodoviaUF || '';
      
      wsRet.getCell('A3').value = 'Legenda:';
      opts.forEach((o, i) => {
          const row = 3 + i;
          const c = wsRet.getCell('B'+row);
          c.value = o.v;
          // Excel argb remove #
          c.fill = { type:'pattern', pattern:'solid', fgColor:{argb:'FF'+o.color.substring(1)} };
          c.alignment = {horizontal:'center'}; c.border = {top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}};
          wsRet.getCell('C'+row).value = o.name || o.l; // Nome completo se tiver
      });

      // Stats Texto
      const statStartRow = 3 + opts.length + 2; 
      wsRet.getCell('A'+statStartRow).value = 'Estatísticas:';
      opts.forEach((o, i) => {
         const row = statStartRow + 1 + i;
         const pct = Math.round((counts[i]/total)*100) || 0;
         wsRet.getCell('A'+row).value = `${o.l}: ${pct}%`;
      });

      // Gráfico
      const chartImg = generatePieChartImage(counts, opts);
      const chartId = wb.addImage({ base64: chartImg.split(',')[1], extension: 'png' });
      wsRet.addImage(chartId, { tl: { col: 4, row: 1 }, ext: { width: 300, height: 250 } });

      // Grid
      const startRow = statStartRow + opts.length + 3;
      wsRet.getCell(`A${startRow}`).value = 'Sentido';
      
      let colIdx = 3;
      kms.forEach(km => {
          const c = wsRet.getCell(startRow, colIdx); c.value = km;
          c.alignment = { textRotation:90, horizontal:'center', vertical:'middle' }; c.font={bold:true};
          c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFE0E0E0'}}; c.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}};
          wsRet.getColumn(colIdx).width = 4;
          colIdx++;
      });

      let rowIdx = startRow + 1;
      sentidos.forEach(s => {
          const cSec = wsRet.getCell(rowIdx, 1); cSec.value = s; cSec.font={bold:true};
          let cK = 3;
          kms.forEach(km => {
              const p = state.data[s]?.[km];
              const c = wsRet.getCell(rowIdx, cK);
              c.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}};
              if(p && p.status){
                 const opt = opts.find(o => o.v === p.status);
                 if(opt) c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF'+opt.color.substring(1)}};
                 c.value = p.status; c.alignment={horizontal:'center'};
              }
              cK++;
          });
          rowIdx++;
      });

      // ABA 2: COLETA
      const wsCol = wb.addWorksheet('Coleta');
      const headers = ["Rodovia", "KM", "Seção", "Status", "Obs", "Foto 1", "Foto 2", "Foto 3"];
      const hRow = wsCol.addRow(headers);
      hRow.eachCell(c => { c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF0B3D91'}}; c.font={color:{argb:'FFFFFFFF'},bold:true}; });
      
      let colRow = 2;
      kms.forEach(km => {
          sentidos.forEach(s => {
              const p = state.data[s]?.[km] || {};
              const row = wsCol.addRow([state.rodoviaUF, km, s, p.status, p.obs, '', '', '']);
              row.height = 80;
              if(p.photos){
                 p.photos.forEach((ph, i) => {
                     if(i>2 || !ph.data) return;
                     const imgId = wb.addImage({base64:ph.data.split(',')[1], extension:'jpeg'});
                     wsCol.addImage(imgId, { tl: { col: 5+i, row: colRow-1 }, ext: { width:100, height:75 }, editAs:'oneCell' });
                 });
              }
              colRow++;
          });
      });

      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf]), `Retigrafico_${state.rodoviaUF || 'Export'}.xlsx`);
    }

    function shareFile() { alert("Use o botão XLSX para baixar e compartilhar manualmente."); }
    function exportCSV(){ alert("Use XLSX para o relatório completo."); }

    async function handlePhoto(e, row, secao, km){ 
        const file = e.target.files[0]; if(!file)return;
        const reader = new FileReader();
        reader.onload = (ev) => { row.photos.push({data:ev.target.result, ts:new Date().toISOString()}); renderAll(); };
        reader.readAsDataURL(file);
    }
    function openSaveModal() { 
       const m = document.getElementById('saveModal'); const i = document.getElementById('saveFileName');
       const t = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
       i.value = state.metadata.name || `Retigrafico - ${t}`;
       m.classList.remove('hidden');
       document.getElementById('btnConfirmSave').onclick = () => { saveFile(i.value); m.classList.add('hidden'); };
    }
    function saveFile(name) {
      if (!currentId) currentId = 'file_' + Date.now();
      state.metadata.name = name; state.metadata.lastModified = new Date().toISOString();
      try { localStorage.setItem(currentId, JSON.stringify(state)); } catch(e) { alert('Erro: Espaço insuficiente.'); return; }
      let list = []; try { list = JSON.parse(localStorage.getItem(INDEX_KEY)) || []; } catch {}
      list = list.filter(item => item.id !== currentId);
      list.push({ id: currentId, name: name, date: new Date().toISOString(), desc: `Km ${state.kmStart} a ${state.kmEnd}` });
      localStorage.setItem(INDEX_KEY, JSON.stringify(list));
      hasUnsavedChanges = false; alert('Salvo!'); document.getElementById('fileLabel').innerText = name;
    }
    function goBack() {
      if (hasUnsavedChanges) {
        document.getElementById('exitModal').classList.remove('hidden');
        document.getElementById('btnExitSave').onclick = () => { openSaveModal(); document.getElementById('exitModal').classList.add('hidden'); };
        document.getElementById('btnExitNoSave').onclick = () => { window.location.href = 'index.html'; };
      } else { window.location.href = 'index.html'; }
    }

    // HANDLERS DE INTERFACE
    document.getElementById('btnReset').onclick = () => requestEditAccess(() => document.getElementById('resetModal').classList.remove('hidden'));
    document.getElementById('btnSafetyExport').onclick = () => exportXLSX();
    document.getElementById('btnConfirmReset').onclick = () => { state.data={}; renderAll(); document.getElementById('resetModal').classList.add('hidden'); };
    document.getElementById('btnSave').onclick = openSaveModal;
    document.getElementById('btnShare').onclick = shareFile;
    document.getElementById('btnExportCSV').onclick = exportCSV;
    document.getElementById('btnExportXLSX').onclick = exportXLSX;
    
    // MODEL SELECT CHANGE
    document.getElementById('modelSelect').onchange = () => requestEditAccess(() => {
        state.model = document.getElementById('modelSelect').value;
        renderAll();
    });

    document.getElementById('btnGerar').onclick = () => requestEditAccess(() => {
        state.kmStart = parseInt(document.getElementById('kmStart').value)||0;
        state.kmEnd = parseInt(document.getElementById('kmEnd').value)||0;
        state.rodoviaUF = document.getElementById('rodoviaUF').value;
        renderAll();
    });
    
    ['rodoviaUF','kmStart','kmEnd'].forEach(id => {
       document.getElementById(id).onchange = () => requestEditAccess(() => {
          if(id==='rodoviaUF') state.rodoviaUF=document.getElementById(id).value;
          else state[id]=parseInt(document.getElementById(id).value)||0;
       });
    });

    document.getElementById('btnTudoBom').onclick = () => requestEditAccess(() => {
        if(!state.kmStart) return;
        if(confirm('Marcar vazios como 1 (Bom/Limpa)?')){
            const kms=range(state.kmStart,state.kmEnd);
            getSecoes().forEach(s=>kms.forEach(k=>{
                ensure(s,k);
                if(!state.data[s][k].status) state.data[s][k].status=1;
            }));
            renderAll();
        }
    });

    init();
  </script>
</body>
</html>
