<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Retigráfico - Multi-Avaliação</title>

  <link rel="manifest" href="manifest.webmanifest?v=6">
  <meta name="theme-color" content="#f8fafc">

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --ok:#8BC34A; --mid:#FFEB3B; --bad:#F44336;
      --worse:#9C27B0; --dead:#212121;
      --yes:#F44336; --no:#8BC34A; /* Sim=Vermelho, Não=Verde */
      --ink:#020617; --muted:#64748b; --brand:#0ea5e9;
      --bg:#f8fafc; --card:#ffffff;
      --radius:16px; --kmA:#f5fbff; --kmB:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,sans-serif;
      margin:0; background:var(--bg); color:var(--ink);
      padding-bottom: 40px;
    }
    .wrap{max-width:1200px;margin:18px auto;padding:0 12px}
    
    header{
      display:flex; align-items:center; gap:12px;
      margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid #e2e8f0;
    }
    .btn-back {
      background:transparent; border:1px solid #cbd5e1; color:var(--muted);
      padding:8px 12px; border-radius:10px; font-weight:600; font-size:14px;
      cursor:pointer; display:flex; align-items:center; gap:4px;
    }

    .card{
      background:var(--card); border-radius:var(--radius);
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); padding:16px;
      border:1px solid #e2e8f0; margin-bottom:12px;
    }
    .grid{display:grid;gap:10px}
    .g-3{grid-template-columns:repeat(3,1fr)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row.center-chips { justify-content: center; width: 100%; }

    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    
    input,button,select{ padding:12px; border-radius:12px; border:1px solid #cbd5e1; font-size:16px; outline:none; }
    input:focus, select:focus{ border-color:var(--brand); }
    input[type=number],input[type=text],select{ background:#fff; width:100%; }
    input[type=checkbox] { width: 20px; height: 20px; accent-color: var(--brand); cursor:pointer; }
    
    button{ background:var(--brand); color:#fff; border:none; cursor:pointer; font-weight:600; }
    button.ghost{ background:#fff; color:var(--brand); border:1px solid var(--brand); }
    button.warn{ background:#fff; color:#d97706; border:1px solid #d97706; }
    button.danger{ background:#fee2e2; color:#ef4444; border:1px solid #ef4444; }
    
    /* ESTILO LISTA VERTICAL DE PARÂMETROS */
    .params-box { background: #f1f5f9; padding: 16px; border-radius: 12px; margin-top: 10px; }
    .check-list { display: flex; flex-direction: column; gap: 12px; }
    .check-row { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 4px 0; }
    .check-row span { font-size: 15px; font-weight: 500; color: var(--ink); }
    .check-row:hover span { color: var(--brand); }

    /* MODAIS */
    .modal-back{ position:fixed; inset:0; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; z-index:100; backdrop-filter:blur(4px); }
    .modal-card { background:#fff; padding:24px; border-radius:16px; width:340px; max-width:90%; text-align:center; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); }
    .hidden{display:none;}

    /* TABELA */
    .table-wrap{ max-height:600px; overflow:auto; border-radius:12px; border:1px solid #e2e8f0; margin-top:12px; }
    table{ border-collapse:separate; border-spacing:0; width:100%; font-size:14px; min-width:800px; }
    th,td{ border-bottom:1px solid #e2e8f0; padding:10px; text-align:center; vertical-align:middle; }
    th{ background:#f1f5f9; font-size:12px; text-transform:uppercase; color:#475569; position:sticky; top:0; z-index:2; font-weight:700; }
    td:first-child, td:nth-child(2) { text-align: left; } 
    
    /* CHIPS */
    .chip{ padding:6px 4px; border-radius:6px; border:1px solid #cbd5e1; background:#f1f5f9; color:#334155; font-size:12px; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; min-width:32px; transition:all 0.1s; margin:0 2px; }
    .chip.active { transform:scale(1.1); border-width:2px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); z-index:1; }
    .chip.ok.active { background:var(--ok); border-color:#558b2f; color:#fff; }
    .chip.mid.active { background:var(--mid); border-color:#fbc02d; color:#000; }
    .chip.bad.active { background:var(--bad); border-color:#c62828; color:#fff; }
    .chip.worse.active { background:var(--worse); border-color:#7B1FA2; color:#fff; }
    .chip.dead.active { background:var(--dead); border-color:#000; color:#fff; }
    .chip.yes.active { background:var(--yes); border-color:#b71c1c; color:#fff; }
    .chip.no.active { background:var(--no); border-color:#33691e; color:#fff; }

    /* FOTOS */
    .photo-thumb{ width:50px; height:50px; object-fit:cover; border-radius:8px; border:1px solid #e2e8f0; cursor:pointer; }
    .photo-grid{ display:flex; gap:4px; flex-wrap:wrap; justify-content:center; }
    .photo-empty{ width:50px; height:50px; border-radius:8px; border:2px dashed #cbd5e1; display:flex; align-items:center; justify-content:center; color:#64748b; cursor:pointer; background:#f8fafc; font-size:18px; }

    /* HEATMAP */
    .heat-grid{ display:grid; gap:1px; margin-top:10px; overflow-x:auto; border-radius:8px; border:1px solid #e2e8f0; background:#e2e8f0; }
    .heat-row{ display:grid; grid-auto-flow:column; }
    .heat-cell{ width:28px; height:28px; font-size:11px; display:flex; align-items:center; justify-content:center; border-right:1px solid #e2e8f0; }
    .heat-label{ width:150px; justify-content:flex-start; padding-left:8px; font-weight:600; background:#fff; font-size:11px; }

    .icon-btn { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .icon-wa { width: 18px; height: 18px; fill: currentColor; }
    @media (max-width:768px){ .g-3{grid-template-columns:1fr} .btn-row{flex-direction:column;align-items:stretch} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <button class="btn-back" onclick="goBack()"><span>&#8592;</span> Voltar</button>
      <img src="app-logo.png" alt="R" style="width:36px;height:36px;border-radius:8px">
      <div style="flex:1">
        <h1 style="font-size:18px;margin:0;line-height:1.2">Retigráfico</h1>
        <div id="fileLabel" class="small" style="color:var(--muted);font-size:12px">Novo Arquivo</div>
      </div>
    </header>

    <div class="card">
      <div class="card-title" style="font-weight:700;margin-bottom:12px">
        <span>1. Parâmetros & Escopo</span>
      </div>
      
      <div class="grid g-3">
        <div><label>Rodovia / UF</label><input id="rodoviaUF" type="text" placeholder="Ex.: BR-040 / MG"></div>
        <div><label>KM Inicial</label><input id="kmStart" type="number" placeholder="Ex.: 256"></div>
        <div><label>KM Final</label><input id="kmEnd" type="number" placeholder="Ex.: 260"></div>
      </div>

      <div class="params-box">
        <label style="margin-bottom:16px;display:block;font-weight:800;font-size:14px;color:var(--brand);text-transform:uppercase;letter-spacing:1px;">Selecione as disciplinas que serão avaliadas:</label>
        
        <div class="check-list">
          <label class="check-row">
            <input type="checkbox" id="checkRocada3"> <span>1. Vegetação (Roçada 1 a 3)</span>
          </label>
          <label class="check-row" style="margin-left: 20px; font-size: 13px; color: var(--muted);">
             <input type="checkbox" id="checkRocada5"> <span>(Ou Detalhada: 1 a 5)</span>
          </label>
          
          <label class="check-row"><input type="checkbox" id="checkDrenagem"> <span>2. Drenagens (1-3)</span></label>
          <label class="check-row"><input type="checkbox" id="checkCata"> <span>3. Cata-Cata (Lixo)</span></label>
          <label class="check-row"><input type="checkbox" id="checkPoda"> <span>4. Poda</span></label>
          <label class="check-row"><input type="checkbox" id="checkEntulho"> <span>5. Recolhimento de Entulho</span></label>
          <label class="check-row"><input type="checkbox" id="checkDefensa"> <span>6. Defensas Danificadas</span></label>
          <label class="check-row"><input type="checkbox" id="checkDispositivo"> <span>7. Dispositivos Danificados</span></label>
        </div>
      </div>

      <div style="margin-top:16px">
        <label>Sentido / Pista</label>
        <div id="sentidosBox" class="row" style="margin-top:8px; gap:12px"></div>
      </div>

      <div class="row btn-row" style="margin-top:16px">
        <button id="btnGerar">Gerar Tabela</button>
        <button id="btnReset" class="ghost warn">Limpar</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="font-weight:700;margin-bottom:12px">
        <span>2. Coleta de Campo</span>
      </div>
      <div class="table-wrap">
        <table id="mainTable">
          <thead id="tableHead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="font-weight:700;margin-bottom:12px">
        <span>3. Visualização (Heatmap)</span>
      </div>
      <div id="heatWrap"></div>

      <div class="row btn-row" style="margin-top:20px; justify-content:flex-end; border-top:1px solid #e2e8f0; padding-top:16px">
        <button id="btnSave" style="background:#64748b">Salvar</button>
        <button id="btnExportXLSX" class="ghost">Baixar Relatório (XLSX)</button>
        <button id="btnShare" style="background:#25D366; color:#fff" class="icon-btn">
          <svg class="icon-wa" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
          Encaminhar
        </button>
      </div>
    </div>
  </div>

  <div id="photoModal" class="modal-back hidden">
    <div style="text-align:center">
      <img id="photoModalImg" src="" style="max-width:95vw;max-height:80vh;border-radius:8px;">
      <div style="margin-top:10px"><button onclick="document.getElementById('photoModal').classList.add('hidden')" style="background:#fff;color:#000;border-radius:20px">Fechar</button></div>
    </div>
  </div>
  <div id="saveModal" class="modal-back hidden">
    <div class="modal-card">
      <h3>Salvar</h3>
      <input id="saveFileName" type="text" style="width:100%;margin-bottom:16px">
      <div class="icon-btn"><button id="btnConfirmSave" style="flex:1">Salvar</button><button onclick="document.getElementById('saveModal').classList.add('hidden')" class="ghost">Cancelar</button></div>
    </div>
  </div>
  <div id="resetModal" class="modal-back hidden">
    <div class="modal-card">
      <h3>⚠️ Limpar Tudo?</h3>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button id="btnConfirmReset" class="danger">Apagar</button>
        <button onclick="document.getElementById('resetModal').classList.add('hidden')" class="ghost">Cancelar</button>
      </div>
    </div>
  </div>
  <div id="changeModal" class="modal-back hidden">
    <div class="modal-card">
      <h3>Alterar Parametros?</h3>
      <p style="font-size:12px">Isso pode resetar dados se mudar a estrutura.</p>
      <div class="icon-btn"><button id="btnAllowEdit">Sim</button><button onclick="document.getElementById('changeModal').classList.add('hidden')" class="ghost">Não</button></div>
    </div>
  </div>

  <script>
    // --- CONFIGURAÇÃO ---
    const INDEX_KEY = 'retigrafico_index_v1';
    let currentId = null;
    let isProtected = false;
    
    // ESTADO PADRÃO (Agora com configurações detalhadas)
    let state = {
      kmStart:0, kmEnd:0, rodoviaUF:'', selectedSecoes:[], 
      data:{},
      config: {
        rocada: '1-3', // 1-3, 1-5, none
        drenagem: false,
        cata: false,
        poda: false,
        entulho: false,
        defensa: false,
        dispositivo: false
      },
      metadata: { created: new Date().toISOString() }
    };

    // OPÇÕES DE VISUALIZAÇÃO
    const OPTS_ROCADA_3 = [
      {v:1, l:'Bom', c:'ok', hex:'8BC34A'}, {v:2, l:'Reg', c:'mid', hex:'FFEB3B'}, {v:3, l:'Cri', c:'bad', hex:'F44336'}
    ];
    const OPTS_ROCADA_5 = [
      {v:1, l:'Bom', c:'ok', hex:'8BC34A'}, {v:2, l:'Reg', c:'mid', hex:'FFEB3B'}, {v:3, l:'Cri', c:'bad', hex:'F44336'},
      {v:4, l:'Pés', c:'worse', hex:'9C27B0'}, {v:5, l:'Int', c:'dead', hex:'212121'}
    ];
    const OPTS_DRENAGEM = [
      {v:1, l:'Lmp', c:'ok', hex:'8BC34A', t:'Limpa'}, {v:2, l:'Suj', c:'mid', hex:'FFEB3B', t:'Suja'}, {v:3, l:'Obs', c:'bad', hex:'F44336', t:'Obstruída'}
    ];
    
    // --- INICIALIZAÇÃO ---
    function init() {
      const p = new URLSearchParams(window.location.search);
      const id = p.get('id');
      
      if (id) {
        const raw = localStorage.getItem(id);
        if (raw) {
          state = JSON.parse(raw);
          // Migração Segura
          if(!state.config) state.config = { rocada:'1-3', drenagem:false, cata:false, poda:false, entulho:false, defensa:false, dispositivo:false };
          currentId = id; isProtected = true;
          document.getElementById('fileLabel').innerText = state.metadata.name || 'Arquivo Salvo';
          disableInputs(true);
        }
      }
      renderAll();
    }

    function disableInputs(disable) {
      document.getElementById('checkRocada3').disabled = disable;
      document.getElementById('checkRocada5').disabled = disable;
      document.getElementById('checkDrenagem').disabled = disable;
      document.getElementById('checkCata').disabled = disable;
      document.getElementById('checkPoda').disabled = disable;
      document.getElementById('checkEntulho').disabled = disable;
      document.getElementById('checkDefensa').disabled = disable;
      document.getElementById('checkDispositivo').disabled = disable;
    }

    function requestEdit(cb) {
      if(isProtected) {
        document.getElementById('changeModal').classList.remove('hidden');
        document.getElementById('btnAllowEdit').onclick = () => {
          isProtected = false; disableInputs(false);
          document.getElementById('changeModal').classList.add('hidden');
          cb();
        };
      } else { cb(); }
    }

    // --- LÓGICA DE DADOS ---
    function range(a,b){ const r=[]; const s=a<=b?1:-1; for(let i=a;i!==b+s;i+=s)r.push(i); return r; }
    function getSecoes(){ return state.selectedSecoes.length ? state.selectedSecoes : ["Sul","CC","Norte"]; }
    
    function ensure(sec, km) {
      state.data[sec] ??= {};
      // Inicializa todos os campos possíveis
      state.data[sec][km] ??= { rocada:null, drenagem:null, cata:null, poda:null, entulho:null, defensa:null, dispositivo:null, photos:[], obs:'' };
    }

    // --- RENDERIZADORES ---
    function renderAll() {
      // Inputs
      document.getElementById('rodoviaUF').value = state.rodoviaUF || '';
      document.getElementById('kmStart').value = state.kmStart || '';
      document.getElementById('kmEnd').value = state.kmEnd || '';
      
      // Checkboxes Logic
      document.getElementById('checkRocada3').checked = (state.config.rocada === '1-3');
      document.getElementById('checkRocada5').checked = (state.config.rocada === '1-5');
      document.getElementById('checkDrenagem').checked = !!state.config.drenagem;
      document.getElementById('checkCata').checked = !!state.config.cata;
      document.getElementById('checkPoda').checked = !!state.config.poda;
      document.getElementById('checkEntulho').checked = !!state.config.entulho;
      document.getElementById('checkDefensa').checked = !!state.config.defensa;
      document.getElementById('checkDispositivo').checked = !!state.config.dispositivo;

      renderSentidosBox();
      renderTable();
      renderHeat(); 
    }

    function renderSentidosBox() {
      const box = document.getElementById('sentidosBox'); box.innerHTML = '';
      ["Sul","CC","Norte","Leste","Oeste"].forEach(s => {
        const wrap = document.createElement('label');
        wrap.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px;background:#fff;border-radius:8px;border:1px solid #e2e8f0';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.value=s;
        if(getSecoes().includes(s)) cb.checked=true;
        cb.onclick = (e) => { 
          if(isProtected) { e.preventDefault(); requestEdit(()=>{ cb.checked=!cb.checked; updateSecoes(); }); }
          else { setTimeout(updateSecoes,0); }
        };
        wrap.append(cb, s); box.appendChild(wrap);
      });
    }
    function updateSecoes() {
      state.selectedSecoes = Array.from(document.querySelectorAll('#sentidosBox input:checked')).map(i=>i.value);
      renderAll();
    }

    // --- TABELA DINÂMICA ---
    function renderTable() {
      const thead = document.getElementById('tableHead');
      const tbody = document.getElementById('tbody');
      thead.innerHTML = ''; tbody.innerHTML = '';
      
      if(!state.kmStart && !state.kmEnd) return;

      const trH = document.createElement('tr');
      trH.innerHTML = `<th>KM</th><th>Seção</th>`;
      
      if(state.config.rocada !== 'none') trH.innerHTML += `<th>Vegetação</th>`;
      if(state.config.drenagem) trH.innerHTML += `<th>Drenagem</th>`;
      if(state.config.cata) trH.innerHTML += `<th>Cata-Cata</th>`;
      if(state.config.poda) trH.innerHTML += `<th>Poda</th>`;
      if(state.config.entulho) trH.innerHTML += `<th>Entulho</th>`;
      if(state.config.defensa) trH.innerHTML += `<th>Defensas</th>`;
      if(state.config.dispositivo) trH.innerHTML += `<th>Dispositivos</th>`;
      
      trH.innerHTML += `<th>Fotos</th><th>Obs</th>`;
      thead.appendChild(trH);

      const kms = range(state.kmStart, state.kmEnd);
      const secs = getSecoes();

      kms.forEach((km, idx) => {
        const bg = idx%2===0 ? 'var(--kmA)' : 'var(--kmB)';
        secs.forEach((sec, sIdx) => {
          ensure(sec, km);
          const rowData = state.data[sec][km];
          const tr = document.createElement('tr');
          tr.style.background = bg;

          if(sIdx===0) {
            const tdK = document.createElement('td');
            tdK.rowSpan = secs.length; tdK.textContent = km;
            tdK.style.cssText='font-weight:800;border-right:1px solid #e2e8f0;font-size:16px;vertical-align:middle;text-align:center';
            tr.appendChild(tdK);
          }
          
          const tdS = document.createElement('td'); tdS.textContent = sec; tr.appendChild(tdS);

          if(state.config.rocada !== 'none') {
             const td = document.createElement('td');
             const opts = state.config.rocada === '1-5' ? OPTS_ROCADA_5 : OPTS_ROCADA_3;
             renderChips(td, rowData, 'rocada', opts);
             tr.appendChild(td);
          }
          if(state.config.drenagem) {
             const td = document.createElement('td');
             renderChips(td, rowData, 'drenagem', OPTS_DRENAGEM);
             tr.appendChild(td);
          }
          if(state.config.cata) renderBinary(tr, rowData, 'cata');
          if(state.config.poda) renderBinary(tr, rowData, 'poda');
          if(state.config.entulho) renderBinary(tr, rowData, 'entulho');
          if(state.config.defensa) renderBinary(tr, rowData, 'defensa');
          if(state.config.dispositivo) renderBinary(tr, rowData, 'dispositivo');

          const tdF = document.createElement('td');
          renderPhotos(tdF, rowData, sec, km);
          tr.appendChild(tdF);

          const tdO = document.createElement('td');
          const imp = document.createElement('input'); 
          imp.value = rowData.obs||''; imp.placeholder='...';
          imp.onchange = () => requestEdit(()=>{ rowData.obs=imp.value; });
          tdO.appendChild(imp); tr.appendChild(tdO);

          tbody.appendChild(tr);
        });
      });
    }

    function renderChips(container, dataObj, key, opts) {
      const div = document.createElement('div');
      div.className = 'row center-chips'; 
      opts.forEach(o => {
        const c = document.createElement('div');
        c.className = `chip ${o.c}`;
        if(dataObj[key] === o.v) c.classList.add('active');
        c.textContent = o.v; c.title = o.l;
        c.onclick = () => requestEdit(() => {
          dataObj[key] = (dataObj[key] === o.v ? null : o.v);
          renderTable(); renderHeat();
        });
        div.appendChild(c);
      });
      container.appendChild(div);
    }

    function renderBinary(tr, dataObj, key) {
      const td = document.createElement('td');
      const div = document.createElement('div');
      div.className = 'row center-chips'; 
      
      const yes = document.createElement('div'); 
      yes.className = 'chip yes'; yes.textContent = 'Sim';
      if(dataObj[key] === 'S') yes.classList.add('active');
      yes.onclick = () => requestEdit(() => { dataObj[key] = (dataObj[key]==='S'?null:'S'); renderTable(); renderHeat(); });

      const no = document.createElement('div'); 
      no.className = 'chip no'; no.textContent = 'Não';
      if(dataObj[key] === 'N') no.classList.add('active');
      no.onclick = () => requestEdit(() => { dataObj[key] = (dataObj[key]==='N'?null:'N'); renderTable(); renderHeat(); });

      div.appendChild(yes); div.appendChild(no);
      td.appendChild(div);
      tr.appendChild(td);
    }

    function renderPhotos(container, dataObj, sec, km) {
      const grid = document.createElement('div'); grid.className='photo-grid';
      (dataObj.photos||[]).forEach((ph, i) => {
         const img = document.createElement('img'); img.src = ph.data; img.className='photo-thumb';
         img.onclick = () => { document.getElementById('photoModalImg').src=ph.data; document.getElementById('photoModal').classList.remove('hidden'); };
         img.oncontextmenu = (e) => { e.preventDefault(); requestEdit(()=>{ if(confirm('Apagar?')) { dataObj.photos.splice(i,1); renderTable(); } }); };
         grid.appendChild(img);
      });
      if((dataObj.photos||[]).length < 3) {
         const add = document.createElement('label'); add.className='photo-empty'; add.innerHTML='+';
         const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.style.display='none';
         inp.onchange = (e) => requestEdit(() => handlePhoto(e, dataObj));
         add.onclick = () => inp.click(); add.appendChild(inp); grid.appendChild(add);
      }
      container.appendChild(grid);
    }
    
    async function handlePhoto(e, dataObj){ 
        const file = e.target.files[0]; if(!file)return;
        const reader = new FileReader();
        reader.onload = (ev) => { dataObj.photos.push({data:ev.target.result, ts:new Date().toISOString()}); renderTable(); };
        reader.readAsDataURL(file);
    }

    // --- VISUAL HEATMAP MULTI-LINHA ---
    function getActiveConfigs() {
      const list = [];
      if(state.config.rocada !== 'none') list.push({ key:'rocada', label:'Vegetação', type:'scale' });
      if(state.config.drenagem) list.push({ key:'drenagem', label:'Drenagens', type:'scale' });
      if(state.config.cata) list.push({ key:'cata', label:'Cata-Cata', type:'bin' });
      if(state.config.poda) list.push({ key:'poda', label:'Poda', type:'bin' });
      if(state.config.entulho) list.push({ key:'entulho', label:'Entulho', type:'bin' });
      if(state.config.defensa) list.push({ key:'defensa', label:'Defensas', type:'bin' });
      if(state.config.dispositivo) list.push({ key:'dispositivo', label:'Dispositivos', type:'bin' });
      return list;
    }

    function renderHeat() {
      const wrap = document.getElementById('heatWrap'); wrap.innerHTML='';
      if(!state.kmStart) return;

      const configs = getActiveConfigs();
      if(configs.length === 0) { wrap.innerHTML = '<div style="padding:10px;text-align:center;color:#999">Nenhuma disciplina avaliada.</div>'; return; }

      const kms = range(state.kmStart, state.kmEnd);
      const frame = document.createElement('div'); frame.className='heat-grid';
      
      const hRow = document.createElement('div'); hRow.className='heat-row';
      hRow.appendChild(Object.assign(document.createElement('div'),{className:'heat-cell heat-label', textContent:'Seção/Disciplina'}));
      kms.forEach(k=>hRow.appendChild(Object.assign(document.createElement('div'),{className:'heat-cell',textContent:k,style:'font-weight:bold;background:#e2e8f0'})));
      frame.appendChild(hRow);

      getSecoes().forEach(s => {
        configs.forEach(conf => {
           const row = document.createElement('div'); row.className='heat-row';
           const labelDiv = document.createElement('div'); 
           labelDiv.className='heat-cell heat-label';
           labelDiv.textContent = `${s} - ${conf.label}`;
           labelDiv.style.fontSize = '10px';
           row.appendChild(labelDiv);

           kms.forEach(k => {
             ensure(s,k); const val = state.data[s][k][conf.key];
             const cell = document.createElement('div'); cell.className='heat-cell';
             
             if(val) {
               let color = '#e0e0e0'; let txtColor = '#000';
               if(conf.type === 'scale') {
                  const opts = (conf.key==='rocada' && state.config.rocada==='1-5') ? OPTS_ROCADA_5 : 
                               (conf.key==='rocada') ? OPTS_ROCADA_3 : OPTS_DRENAGEM;
                  const found = opts.find(o => o.v === val);
                  if(found) { color = '#'+found.hex; if(['worse','dead'].includes(found.c)) txtColor='#fff'; }
               } else {
                  if(val === 'S') { color = '#F44336'; txtColor='#fff'; } // Problema
                  if(val === 'N') { color = '#8BC34A'; txtColor='#fff'; } // Ok
               }
               cell.style.background = color; cell.style.color = txtColor; cell.textContent = val;
             }
             row.appendChild(cell);
           });
           frame.appendChild(row);
        });
      });
      wrap.appendChild(frame);
    }

    // --- EXPORTAÇÃO XLSX ---
    async function exportXLSX() {
      if(!state.kmStart) { alert('Sem dados.'); return; }
      const wb = new ExcelJS.Workbook();
      const kms = range(state.kmStart, state.kmEnd);
      const configs = getActiveConfigs();

      // ABA 1: VISUAL
      const wsRet = wb.addWorksheet('Retigrafico');
      wsRet.mergeCells('A1:B1'); wsRet.getCell('A1').value = 'Rodovia/UF'; wsRet.getCell('A1').font={bold:true};
      wsRet.getCell('C1').value = state.rodoviaUF || '';
      
      const startRow = 3;
      wsRet.getCell(`A${startRow}`).value = 'Disciplina Avaliada';
      wsRet.getColumn(1).width = 30;

      let colIdx = 2;
      kms.forEach(km => {
         const c = wsRet.getCell(startRow, colIdx); 
         c.value = km;
         c.alignment = { textRotation:90, horizontal:'center', vertical:'middle' }; 
         c.font={bold:true}; c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFE0E0E0'}};
         c.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}};
         wsRet.getColumn(colIdx).width = 4;
         colIdx++;
      });

      let rowIdx = startRow + 1;
      getSecoes().forEach(s => {
         configs.forEach(conf => {
            const labelCell = wsRet.getCell(rowIdx, 1);
            labelCell.value = `${s} - ${conf.label}`;
            labelCell.font = {bold:true, size:10};
            labelCell.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}};
            
            let cK = 2;
            kms.forEach(km => {
               const val = state.data[s]?.[km]?.[conf.key];
               const cell = wsRet.getCell(rowIdx, cK);
               cell.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}};
               cell.alignment={horizontal:'center', vertical:'middle'};
               
               if(val) {
                  cell.value = val;
                  let argb = 'FFEEEEEE';
                  if(conf.type === 'scale') {
                     const opts = (conf.key==='rocada' && state.config.rocada==='1-5') ? OPTS_ROCADA_5 : 
                                  (conf.key==='rocada') ? OPTS_ROCADA_3 : OPTS_DRENAGEM;
                     const found = opts.find(o => o.v === val);
                     if(found) argb = 'FF' + found.hex;
                  } else {
                     if(val === 'S') argb = 'FFF44336';
                     if(val === 'N') argb = 'FF8BC34A';
                  }
                  cell.fill = { type:'pattern', pattern:'solid', fgColor:{argb:argb} };
               }
               cK++;
            });
            rowIdx++;
         });
      });

      // ABA 2: COLETA
      const ws = wb.addWorksheet('Coleta');
      const headers = ["Rodovia", "KM", "Seção"];
      if(state.config.rocada !== 'none') headers.push("Vegetação");
      if(state.config.drenagem) headers.push("Drenagens");
      if(state.config.cata) headers.push("Cata-Cata");
      if(state.config.poda) headers.push("Poda");
      if(state.config.entulho) headers.push("Entulho");
      if(state.config.defensa) headers.push("Defensas");
      if(state.config.dispositivo) headers.push("Dispositivos");
      headers.push("Obs", "Foto 1", "Foto 2", "Foto 3");
      
      const hRow = ws.addRow(headers);
      hRow.eachCell(c => { c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF0B3D91'}}; c.font={color:{argb:'FFFFFFFF'},bold:true}; });

      let imgRow = 2;
      kms.forEach(km => {
        getSecoes().forEach(sec => {
          const d = state.data[sec]?.[km] || {};
          const rowData = [state.rodoviaUF, km, sec];
          
          if(state.config.rocada !== 'none') rowData.push(d.rocada);
          if(state.config.drenagem) rowData.push(d.drenagem);
          if(state.config.cata) rowData.push(d.cata);
          if(state.config.poda) rowData.push(d.poda);
          if(state.config.entulho) rowData.push(d.entulho);
          if(state.config.defensa) rowData.push(d.defensa);
          if(state.config.dispositivo) rowData.push(d.dispositivo);
          rowData.push(d.obs, '', '', '');

          const r = ws.addRow(rowData);
          r.height = 70;
          
          if(d.photos) {
            d.photos.forEach((ph, i) => {
              if(i>2 || !ph.data) return;
              const imgId = wb.addImage({base64:ph.data.split(',')[1], extension:'jpeg'});
              const colIdx = headers.length - 3 + i;
              ws.addImage(imgId, { tl:{col:colIdx, row:imgRow-1}, ext:{width:90, height:60} });
            });
          }
          imgRow++;
        });
      });

      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf]), `Retigrafico_${state.rodoviaUF || 'Multi'}.xlsx`);
    }

    // --- INTERFACE EVENTS ---
    // Roçada Gangorra
    document.getElementById('checkRocada3').onclick = (e) => handleRocadaCheck('1-3', e);
    document.getElementById('checkRocada5').onclick = (e) => handleRocadaCheck('1-5', e);

    function handleRocadaCheck(mode, e) {
      if(isProtected) {
        e.preventDefault();
        requestEdit(() => { 
          // Se já estava nesse modo e clicou, desmarca (vira none)
          if(state.config.rocada === mode) {
             state.config.rocada = 'none';
          } else {
             state.config.rocada = mode;
          }
          renderAll();
        });
      } else {
          // Lógica direta
          if(state.config.rocada === mode) {
             state.config.rocada = 'none';
          } else {
             state.config.rocada = mode;
          }
          renderAll();
      }
    }

    // Checkboxes normais
    ['checkDrenagem','checkCata','checkPoda','checkEntulho','checkDefensa','checkDispositivo'].forEach(id => {
       document.getElementById(id).onclick = (e) => {
         const key = id.replace('check','').toLowerCase();
         if(isProtected) { e.preventDefault(); requestEdit(() => { state.config[key] = !state.config[key]; renderAll(); }); }
         else { state.config[key] = document.getElementById(id).checked; renderAll(); }
       };
    });

    document.getElementById('btnGerar').onclick = () => requestEdit(() => {
        state.kmStart = parseInt(document.getElementById('kmStart').value)||0;
        state.kmEnd = parseInt(document.getElementById('kmEnd').value)||0;
        state.rodoviaUF = document.getElementById('rodoviaUF').value;
        renderAll();
    });
    
    // Handlers padrão
    document.getElementById('btnSave').onclick = openSaveModal;
    document.getElementById('btnExportXLSX').onclick = exportXLSX;
    document.getElementById('btnReset').onclick = () => requestEdit(() => document.getElementById('resetModal').classList.remove('hidden'));
    document.getElementById('btnConfirmReset').onclick = () => { state.data={}; renderAll(); document.getElementById('resetModal').classList.add('hidden'); };
    function goBack() { window.location.href = 'index.html'; }
    function openSaveModal() {
       document.getElementById('saveModal').classList.remove('hidden');
       const nameInp = document.getElementById('saveFileName');
       nameInp.value = state.metadata.name || `Retigráfico - ${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}`;
       document.getElementById('btnConfirmSave').onclick = () => {
         const name = nameInp.value;
         if(!currentId) currentId = 'file_'+Date.now();
         state.metadata.name = name;
         state.metadata.lastModified = new Date().toISOString();
         localStorage.setItem(currentId, JSON.stringify(state));
         let idx = JSON.parse(localStorage.getItem(INDEX_KEY) || '[]');
         idx = idx.filter(x => x.id !== currentId);
         idx.push({ id:currentId, name:name, date:state.metadata.lastModified, desc:`Km ${state.kmStart}-${state.kmEnd}` });
         localStorage.setItem(INDEX_KEY, JSON.stringify(idx));
         document.getElementById('fileLabel').innerText = name;
         document.getElementById('saveModal').classList.add('hidden');
         isProtected = true; disableInputs(true);
         alert('Salvo!');
       };
    }

    init();
  </script>
</body>
</html>
